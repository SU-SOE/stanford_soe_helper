<?php

/**
 * @file
 * Code for the Stanford SOE Helper module.
 */


/**
 * Implements hook_help().
 */
function stanford_soe_helper_help($path, $arg) {

  if ($path == 'admin/help#stanford_soe_helper') {
    $output = '<h3>' . t('About the Stanford SoE Helper') . '</h3>';
    $output .= '<p>' . t('The Stanford SoE Helper module provides settings specific for the SoE site.') . '</p>';
    $output .= l(t("See README.md"), drupal_get_path('module', 'stanford_soe_helper') . '/README.md');
    return $output;
  }
}

/**
 * Implements hook_init().
 */
function stanford_soe_helper_init() {

  // Add css files
  $file_paths = array(
    drupal_get_path('module', 'stanford_soe_helper') . "/css/soe_helper.css",
    drupal_get_path('module', 'stanford_soe_helper') . "/css/stanford_news_layouts.css"
  );

  // CSS Injector file weights start at 200.
  // See http://www.rit.edu/drupal/api/drupal/sites!all!modules!css_injector!css_injector.module/7.43.
  $weight = 190;
  $conditions = "admin
admin*
admin/*
block/*/edit*
block/add*
block/*/delete
node/*/edit
node/add*
node/*/delete
user/*/edit";

  $css_rules = array();
  $css_rules['rule_conditions'] = $conditions;
  $css_rules['rule_type'] = CSS_INJECTOR_PAGES_NOTLISTED;

  $pass = _css_injector_evaluate_rule($css_rules);
  if ($pass) {
    foreach ($file_paths as $file_path) {

      drupal_add_css($file_path, array(
        'type' => 'file',
        'group' => CSS_THEME,
        'media' => "all",
        'preprocess' => TRUE,
        'weight' => $weight
      ));
      $weight = $weight++;
    }
  }
}

/**
 * Implements hook_menu().
 */
function stanford_soe_helper_menu() {
  $items['pingdom/webhook'] = array(
    'page callback' => 'stanford_soe_helper_cc',
    'access callback' => 'verify_pingdom',
    'type' => MENU_CALLBACK,
  );
  return $items;
}

function verify_pingdom() {
  $stanford_soe_helper_pingdom_token = variable_get('stanford_soe_helper_pingdom_token');
  if (isset($_GET['token']) && $_GET['token'] == $stanford_soe_helper_pingdom_token) {
    return TRUE;
  } else {
    return FALSE;
  }
}

/**
 * Custom page callback.
 */
function stanford_soe_helper_cc() {
  $flush_caches = &drupal_static(__FUNCTION__);
  $fifteen_minutes_ago = strtotime('15 minutes ago');
  $stanford_soe_helper_last_cc = variable_get('stanford_soe_helper_last_cc', 0);
  if (!isset($flush_caches) && ($fifteen_minutes_ago > $stanford_soe_helper_last_cc)) {
    $stanford_soe_helper_pingdom_token = variable_get('stanford_soe_helper_pingdom_token');
    if (isset($_GET['token']) && $_GET['token'] == $stanford_soe_helper_pingdom_token) {
      drupal_flush_all_caches();
      watchdog('pingdom', 'drupal cache was cleared after pingdom alert');
      variable_set('stanford_soe_helper_last_cc', REQUEST_TIME);
    }
  }
  return '';
}

/**
 * Implements hook_form_FORM_ID_alter() for stanford_news_item_node_form.
 */
function stanford_soe_helper_form_stanford_news_item_node_form_alter(
  &$form,
  &$form_state,
  $form_id) {

  // Handle deprecation of image credits.
  if (function_exists('stanford_news_extras_deprecate_image_credits')) {
    stanford_news_extras_deprecate_image_credits($form, $form_id);
  }
}

function stanford_soe_helper_form_stanford_search_api_search_block_form_alter(
  &$form,
  &$form_state,
  $form_id) {

dpm ($form);

  }
